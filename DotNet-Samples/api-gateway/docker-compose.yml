version: "3.8"

services:
  consul:
    image: consul:1.17
    container_name: consul
    ports:
      - "8500:8500" # HTTP API and Web UI
      - "8600:8600/udp" # DNS
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    networks:
      - api-gateway-net
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5

  mock-user-service:
    build:
      context: .
      dockerfile: tests/MockServices/MockUserService/Dockerfile
    container_name: mock-user-service
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_NAME=user-service
      - SERVICE_PORT=8080
    depends_on:
      consul:
        condition: service_healthy
    networks:
      - api-gateway-net
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  product-service:
    build:
      context: ./src/ProductService
      dockerfile: Dockerfile
    container_name: product-service
    ports:
      - "5002:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
    networks:
      - api-gateway-net
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  api-gateway:
    build:
      context: .
      dockerfile: src/ApiGateway.Api/Dockerfile
    container_name: api-gateway
    ports:
      - "5299:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Consul__Host=consul
      - Consul__Port=8500
      - JwtSettings__SecretKey=your-secret-key-min-32-characters-long-for-production
      - JwtSettings__Issuer=ApiGateway
      - JwtSettings__Audience=ApiGatewayClients
    depends_on:
      consul:
        condition: service_healthy
      mock-user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
    networks:
      - api-gateway-net
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

networks:
  api-gateway-net:
    driver: bridge
